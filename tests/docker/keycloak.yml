services:
  keycloak:
    image: quay.io/keycloak/keycloak:23.0.4
    environment:
      KEYCLOAK_ADMIN: "admin"
      KEYCLOAK_ADMIN_PASSWORD: "admin"
      DB_VENDOR: H2
    command:
      - start-dev
      - --hostname=keycloak
      - --hostname-port=8080
      - --hostname-strict-backchannel=true
    post_start:
      - command:
          - /bin/bash
          - -c
          - |
            set -xe
            kcadm_login() {
              /opt/keycloak/bin/kcadm.sh config credentials \
              --server http://keycloak:8080 \
              --realm master \
              --user admin \
              --password admin
            }
            until kcadm_login; do
              echo "Waiting for Keycloak to be ready..."
              sleep 2
            done
            
            /opt/keycloak/bin/kcadm.sh update realms/master -s sslRequired=NONE
    ports:
      - 9090:8080